<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Site info -->
    <title>Eagles Super Bowl LII Victory Parade Map</title>
    <meta name="description" content="Find the nearest bar and explore map of parade day transit info.">
    <meta name="author" content="Dan Ford">

    <!-- Favicon -->
    <link rel="shortcut icon" href="images/football.png">

    <!-- Metatags -->
    <meta property="og:title" content="Eagles Super Bowl LII Victory Parade Map" />
    <meta property="og:url" content="eaglessuperbowlparade.com" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="Find the nearest bar and explore map of parade day transit info." />
    <meta property="og:image" content="images/eagles-parade-map.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Eagles Super Bowl LII Victory Parade Map" />
    <meta name="tiwtter:creator" content="@danjford" />
    <meta name="twitter:description" content="Find the nearest bar and explore map of parade day transit info." />
    <meta name="twitter:url" content="eaglessuperbowlparade.com" />
    <meta property="og:image" content="images/eagles-parade-map.png" />

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="css/main.css" />

    <!-- Mapbox GL JS -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Turf.js -->
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>

    <!-- Font Awesome icon library -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

    <!-- jQuery -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <!-- Local JSON files -->
    <script>
        $.getJSON('data/bars.geojson', function(data){
            window.barRestaurantGeoJSON = data;
        });
    </script>
</head>
<body>
    <div class="grid">
        <!-- Header -->
        <div class="header">
            <div>
                <a href="#" id="desktop-info" class="btn btn-light-green">More Info</a>
            </div>
        </div>
        <!-- Header -->
        <!-- Title -->
        <div class="title">
            <h1><i class="fas fa-football-ball"></i> Eagles Victory Parade Map</h1>
        </div>
        <!-- Title -->
        <!-- Sidebar -->
        <sidebar>
            <div>
                <h4><center>Click the button to find the nearest bar or restaurant along the parade route!<center></h4>
            </div>
            <div>
                <a href="#" id="find-nearest-eatery-desktop" class="btn btn-light-green">Find Closest Bar</a>
            </div>
            <div class="block">
                <h4><center>Toggle Layers</center></h4>
                <nav id="layers" class="btn-toggle"></nav>
            </div>
            <div class="block">
                <h4>Parade Details</h4>
                <p>
                    <strong>Date:</strong> Thursday, February 8, 2018</br>
                    <strong>Start Time:</strong> 11 AM</br>
                    <strong>Route:</strong>
                    <ul>
                        <li>Start at Broad and Pattison</li>
                        <li>North on Broad Street to S. Penn Square</li>
                        <li>West on S. Penn Square to 15th Street</li>
                        <li>North on 15th Street to JFK Blvd.</li>
                        <li>West on JFK Blvd. to 16th Street</li>
                        <li>North on 16th Street to the Benjamin Franklin Parkway</li>
                        <li>West on the Benjamin Franklin Parkway to Eakins Oval</li>
                        <li>End at Philadelphia Museum of Art</li>
                    </ul>
                </p>
            </div>
        </sidebar>
        <!-- Sidebar -->
        <!-- Map -->
        <maparea id="map"></maparea>
        <!-- Map -->
        <!-- Footer -->
        <div class="footer">
            <div>
                <a href="#" id="find-nearest-eatery-mobile" class="btn btn-light-green">Find Closest Bar</a>
            </div>
            <div>
                <a href="#" id="mobile-info" class="btn btn-green">More Info</a>
            </div>
        </div>
        <!-- Footer -->
    </div>
    <!-- Modal -->
    <div id="about-modal" class="modal">
    <!-- Modal Content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close"><i class="fa fa-times" aria-hidden="true"></i></span>
                <h3>Super Bowl LII Champions!</h3>
            </div>
            <div class="modal-body">
                <h4>Record-setting game</h4>
                <p>The <a href="http://www.philadelphiaeagles.com/">Philadelphia Eagles</a> won the 2018 Lombardi Trophy for the first time in franchise history, beating the New England Patriots with a score of 41-33 on Sunday, February 4, 2018.</p>
                <p>Now it's time to celebrate!</p>
                <p>Use this map to find a bar closest to your current location. Click the "Find Closest Bar" button to get started!</p>
                <p>Want to keep reliving those magical moments from Sunday? Check out this <a href="https://www.youtube.com/watch?v=qW1xbhW2PEE" target='_blank'>video of game highlights</a>!</p>
                <h4>Sources</h4>
                <p>This tool was built by:<br>
                    <a href="https://www.twitter.com/danjford/" target='_blank'>Dan Ford</a></br>
                    <a href="https://twitter.com/k_llyi" target='_blank'>Kelly Innes</a></br>
                    <a href="https://twitter.com/CRVanPollard" target='_blank'>Chris Pollard</a>
                </p>
                <p>The map was styled with <a href="https://www.mapbox.com/" target='_blank'>Mapbox</a> services and built using <a href="https://www.mapbox.com/mapbox-gl-js/api/" target='_blank'>Mapbox GL JS</a> and <a href="http://turfjs.org/" target='_blank'>Turf</a>.</p>
                <p>The parade route was digitized in Mapbox Studio. Bar information was downloaded from <a href="https://www.openstreetmap.org/" target='_blank'>OpenStreetMap</a> using <a href="https://overpass-turbo.eu/" target='_blank'>Overpass Turbo</a>. Additional bar data and Free Bud Light locations were added thanks to users <a href="https://www.reddit.com/r/philadelphia/comments/7vym6y/bar_crawl_route_for_the_parade_a_list_of_every/ target="_blank">brownandwhite2 and nsjersey</a> on Reddit. Septa Transit line and station status data compiled by Chris Pollard. Parade details collected from <a href="http://6abc.com/sports/full-details-for-eagles-super-bowl-parade-and-ceremony/3036697/" target='_blank'>6abc</a>.</p>
            </div>
        </div>
    </div>
    <!-- Modal -->

<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuamZvcmQiLCJhIjoiY2pkYW5nMmlkM3V4ajJxbnc5a3Bna3FvciJ9.eWvqcTNrJtMx0YCI1dwPqA';
const MAP = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/danjford/cjdanyxn35c9j2spkshl6ww1z',
  minZoom: 9,
  zoom: 12,
  center: [-75.165367, 39.937921],
  bearing: 8.80,
  hash: true,
});

const DATA_SOURCES = {
  paradeRoute: 'mapbox://danjford.cjdam66c24ry52xnxbm8gixuv-8lrj4',
  paradeStart: 'mapbox://danjford.cjdaoair75amq33s60hdhrgft-7jrln',
  paradeEnd: 'mapbox://danjford.cjdb0bzg22m2d2qr2hwdxtxhp-37jcx',
  phillyBarsRest: 'mapbox://danjford.cjdax71e63nqk2qrzm63oeall-1nrcg',
  phillyTransitLines: 'mapbox://danjford.cjddntj1n01au2wm255vcypkb-2ggtb',
  phillyTransitStations: 'mapbox://danjford.cjddns0pz042t2xqoa4h3l7u3-1isol',
};

const POPUP = new mapboxgl.Popup ({
    closeButton: true,
    closeOnClick: true
});

let eateryButtonActive = false;

const geolocateControl = new mapboxgl.GeolocateControl({
     positionOptions: {
         enableHighAccuracy: true,
     },
     trackUserLocation: false,
});

geolocateControl.on('geolocate', ev => {
     if (eateryButtonActive) {
         const data = {
             type: 'Point',
             coordinates: [
                 ev.coords.longitude,
                 ev.coords.latitude
             ],
         };

         let loclong = data.coordinates[0];
         let loclat = data.coordinates[1];

         const nearest = window.barRestaurantGeoJSON.features.map(feature =>
             [
                 turf.distance(data, feature),
                 feature,
             ]);

         const sortedNearest = nearest.sort((first, second) => {
             if (first[0] > second[0]) {
                 return 1;
             } else if (second[0] > first[0]) {
                 return -1;
             }

             return 0;
         });

         const nearestEatery = sortedNearest[0];
         console.log(nearestEatery[1]);
         eateryButtonActive = false;

         if (nearestEatery[1] !== null) {

         MAP.getSource('nearest-eatery').setData({
             type: 'FeatureCollection',
             features: [
                 nearestEatery[1]
             ]
            }
         );

         MAP.addLayer({
             id: 'nearest-eatery',
             type: 'circle',
             source: 'nearest-eatery',
             paint: {
                 'circle-stroke-color' : '#fff',
                 'circle-stroke-width': 2,
                 'circle-radius': 12,
                 'circle-color': '#9d01ff'
                }
            });
          }

          const sortedLons = [data.coordinates[0], nearestEatery[1].geometry.coordinates[0]].sort((a, b) => {
              if (a > b) {
                  return 1;
              } else if (a.distance < b.distance) {
                  return -1;
              }
              return 0;
          });

          const sortedLats = [data.coordinates[1], nearestEatery[1].geometry.coordinates[1]].sort((a, b) => {
              if (a > b) {
                  return 1;
              } else if (a.distance < b.distance) {
                  return -1;
              }
              return 0;
          });

          MAP.fitBounds([
              [sortedLons[0], sortedLats[0]],
              [sortedLons[1], sortedLats[1]],
           ], {
             padding: 100,
           });
       }
 });

var onEateryClick = function(e) {
    eateryButtonActive = true;
    geolocateControl._onClickGeolocate(e);
};

document.getElementById("find-nearest-eatery-desktop").onclick = onEateryClick;
document.getElementById("find-nearest-eatery-mobile").onclick = onEateryClick;

MAP.addControl(geolocateControl);

MAP.addControl(new mapboxgl.NavigationControl());

MAP.on('load', function () {
    MAP.addSource('parade-route', {
        type: 'vector',
        url: DATA_SOURCES.paradeRoute
    });
    MAP.addLayer({
        "id": "parade-route",
        "source": "parade-route",
        "source-layer": "parade-route",
        "type": "line",
        "layout": {
            "visibility": "visible"
        },
        "paint": {
            "line-color": "#0091a1",
            "line-opacity": 0.9,
            "line-width": 7
        }
    });

    MAP.addSource('parade-start', {
        type: 'vector',
        url: DATA_SOURCES.paradeStart
    });
    MAP.addLayer({
        "id": "parade-start",
        "source": "parade-start",
        "source-layer": "parade-start",
        "type": "circle",
        "layout": {
            "visibility": "visible",
        },
        'paint': {
            'circle-stroke-color' : '#fff',
            'circle-stroke-width': 2,
            'circle-radius': {
                'base': 1.75,
                'stops': [[12, 8], [22, 180]]
            },
            'circle-color': '#00aaea'
        }
    });

    MAP.addSource('parade-end', {
        type: 'vector',
        url: DATA_SOURCES.paradeEnd
    });
    MAP.addLayer({
        "id": "parade-end",
        "source": "parade-end",
        "source-layer": "parade-end",
        "type": "circle",
        "layout": {
            "visibility": "visible"
        },
        'paint': {
            'circle-stroke-color' : '#fff',
            'circle-stroke-width': 2,
            'circle-radius': {
                'base': 1.75,
                'stops': [[12, 8], [22, 180]]
            },
            'circle-color': '#00aaea'
        },
    });

    MAP.addSource('philly-transit-lines', {
        type: 'vector',
        url: DATA_SOURCES.phillyTransitLines
    });
    MAP.addLayer({
        "id": "philly-transit-lines",
        "source": "philly-transit-lines",
        "source-layer": "philly-transit-lines",
        "type": "line",
        "layout": {
            "visibility": "visible"
        },
        "paint": {
            "line-color": "#444",
            "line-opacity": 0.9,
            "line-width": 3
        }
    });

    MAP.addSource('philly-transit-stations', {
        type: 'vector',
        url: DATA_SOURCES.phillyTransitStations
    });
    MAP.addLayer({
        "id": "philly-transit-stations",
        "source": "philly-transit-stations",
        "source-layer": "philly-transit-stations",
        "type": "circle",
        "layout": {
            "visibility": "visible"
        },
        'paint': {
            'circle-stroke-color' : '#fff',
            'circle-stroke-width': 1,
            'circle-radius': {
                'base': 1.75,
                'stops': [[12, 5], [22, 60]]
            },
            'circle-color': {
              property: 'ESCORE',
              stops: [
              [1, '#df325a'],
              [2, '#32df8f']
              ]
             }
           }
    });

    MAP.addSource('philly-bars-rest', {
        type: 'vector',
        url: DATA_SOURCES.phillyBarsRest
    });
    MAP.addLayer({
        "id": "philly-bars-rest",
        "source": "philly-bars-rest",
        "source-layer": "philly-bars",
        "type": "symbol",
        "layout": {
            "visibility": "visible",
            "icon-image": "beer-15"
        },
        'paint': {}
    });

    MAP.addSource('nearest-eatery', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: [
            ]
        }
    });

    // TODO: refactor popup section
    // enable POPUP
    MAP.on('click', 'philly-bars-rest', function(e) {
      POPUP.remove();
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['philly-bars-rest'] });
        if (!features.length) {
          return;
        }
        let feature = features[0];
        let amenityType = feature.properties.amenity;
        let amenityName = feature.properties.name;

        POPUP.setLngLat(e.lngLat);
        POPUP.setHTML('<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'><strong>' + "Type: " + '</strong>' + amenityType + '</br><strong>' + "Name: " + '</strong>' + amenityName + '</div>');
        POPUP.addTo(MAP);
    });

    MAP.on('mouseenter', 'philly-bars-rest', function(e) {
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['philly-bars-rest'] });
        MAP.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });

    MAP.on('mouseleave', 'philly-bars-rest', function(e) {
        MAP.getCanvas().style.cursor = '';
    });

    MAP.on('click', 'philly-transit-stations', function(e) {
      POPUP.remove();
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['philly-transit-stations'] });
        if (!features.length) {
          return;
        }
        let feature = features[0];
        let lineTitle = feature.properties.LINE;
        let paradeStatus = feature.properties.EAGLES;
        let stationName = feature.properties.STATION;

        POPUP.setLngLat(e.lngLat);
        POPUP.setHTML('<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'><strong>' + "Line: " + '</strong>' + lineTitle + '</br><strong>' + "Station: " + '</strong>' + stationName + '</br><strong>' + "Open: " + '</strong>' + paradeStatus + '</div>');
        POPUP.addTo(MAP);
    });

    MAP.on('mouseenter', 'philly-transit-stations', function(e) {
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['philly-transit-stations'] });
        MAP.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });

    MAP.on('mouseleave', 'philly-transit-stations', function(e) {
        MAP.getCanvas().style.cursor = '';
    });

    MAP.on('mouseover', 'parade-route', function(e) {
      POPUP.remove();
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['parade-route'] });
        if (!features.length) {
          return;
        }
        let feature = features[0];

        POPUP.setLngLat(e.lngLat);
        POPUP.setHTML('<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'><strong>' + "Parade Route" + '</strong></div>');
        POPUP.addTo(MAP);
    });

    MAP.on('mouseenter', 'parade-route', function(e) {
        let features = MAP.queryRenderedFeatures(e.point, { layers: ['parade-route'] });
        MAP.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });

    MAP.on('mouseleave', 'parade-route', function(e) {
        MAP.getCanvas().style.cursor = '';
        POPUP.remove();
    });

    // toggle layers
    let toggleLayerIds = [ 'philly-transit-lines', 'philly-transit-stations' ];

    for (var i = 0; i < toggleLayerIds.length; i++) {

        let layerNames =  [ 'Transit Lines', 'Transit Stations' ];

        let names = layerNames[i];

        let id = toggleLayerIds[i];

        let link = document.createElement('a');
        link.href = '#';
        link.className = 'active';
        link.textContent = names;

        link.onclick = function (e) {
            let clickedLayer = id;
            e.preventDefault();
            e.stopPropagation();

            let visibility = MAP.getLayoutProperty(clickedLayer, 'visibility');

            if (visibility === 'visible') {
                MAP.setLayoutProperty(clickedLayer, 'visibility', 'none');
                this.className = '';
            } else {
                this.className = 'active';
                MAP.setLayoutProperty(clickedLayer, 'visibility', 'visible');
            }
        };

        let layers = document.getElementById('layers');
        layers.appendChild(link);
    }

});

</script>
<script src="js/desktop-info-popup.js"></script>
<script src="js/mobile-info-popup.js"></script>
</body>
</html>
